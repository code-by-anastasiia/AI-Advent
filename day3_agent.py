from anthropic import Anthropic
from datetime import datetime
import json
from dotenv import load_dotenv
import os

load_dotenv()
api_key = os.getenv("ANTHROPIC_API_KEY")

if not api_key:
    print("–û—à–∏–±–∫–∞: API –∫–ª—é—á –Ω–µ –Ω–∞–π–¥–µ–Ω!")
    print("–°–æ–∑–¥–∞–π—Ç–µ —Ñ–∞–π–ª .env –∏ –¥–æ–±–∞–≤—å—Ç–µ: ANTHROPIC_API_KEY=–≤–∞—à-–∫–ª—é—á")
    print("–ü–æ–ª—É—á–∏—Ç—å –∫–ª—é—á: https://console.anthropic.com")
    exit(1)

client = Anthropic(api_key=api_key)

SYSTEM_PROMPT = """
–¢—ã - –æ–ø—ã—Ç–Ω—ã–π —Ç—Ä–µ–≤–µ–ª-–∞–≥–µ–Ω—Ç, –∫–æ—Ç–æ—Ä—ã–π –ø–æ–º–æ–≥–∞–µ—Ç —Å–ø–ª–∞–Ω–∏—Ä–æ–≤–∞—Ç—å –∏–¥–µ–∞–ª—å–Ω–æ–µ –ø—É—Ç–µ—à–µ—Å—Ç–≤–∏–µ.

–¢–í–û–Ø –ó–ê–î–ê–ß–ê:
–°–æ–±—Ä–∞—Ç—å –í–°–Æ –Ω–µ–æ–±—Ö–æ–¥–∏–º—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –¥–ª—è —Å–æ—Å—Ç–∞–≤–ª–µ–Ω–∏—è –ø–ª–∞–Ω–∞ –ø—É—Ç–µ—à–µ—Å—Ç–≤–∏—è —á–µ—Ä–µ–∑ –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω—ã–π –¥–∏–∞–ª–æ–≥.

–í–ê–ñ–ù–ê–Ø –ò–ù–§–û–†–ú–ê–¶–ò–Ø, –ö–û–¢–û–†–£–Æ –ù–£–ñ–ù–û –£–ó–ù–ê–¢–¨ (–º–∏–Ω–∏–º—É–º):
- –ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ (–∫—É–¥–∞ –µ–¥–µ–º)
- –î–∞—Ç—ã –∏–ª–∏ —Å–µ–∑–æ–Ω –ø–æ–µ–∑–¥–∫–∏
- –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –ø–æ–µ–∑–¥–∫–∏
- –ë—é–¥–∂–µ—Ç
- –ò–Ω—Ç–µ—Ä–µ—Å—ã –∏ –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è –ø—É—Ç–µ—à–µ—Å—Ç–≤–µ–Ω–Ω–∏–∫–∞

–¢–´ –°–ê–ú –†–ï–®–ê–ï–®–¨:
- –ö–∞–∫–∏–µ –ò–ú–ï–ù–ù–û –≤–æ–ø—Ä–æ—Å—ã –∑–∞–¥–∞–≤–∞—Ç—å (–∏—Å—Ö–æ–¥—è –∏–∑ —Å–∏—Ç—É–∞—Ü–∏–∏)
- –°–∫–æ–ª—å–∫–æ –≤–æ–ø—Ä–æ—Å–æ–≤ –∑–∞–¥–∞—Ç—å (–ú–ò–ù–ò–ú–£–ú 5, –Ω–æ –º–æ–∂–Ω–æ –±–æ–ª—å—à–µ –µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
- –í –∫–∞–∫–æ–º –ø–æ—Ä—è–¥–∫–µ —Å–ø—Ä–∞—à–∏–≤–∞—Ç—å
- –ù—É–∂–Ω—ã –ª–∏ —É—Ç–æ—á–Ω—è—é—â–∏–µ –≤–æ–ø—Ä–æ—Å—ã

–ù–∞–ø—Ä–∏–º–µ—Ä, –µ—Å–ª–∏ —É–∑–Ω–∞–ª —á—Ç–æ –µ–¥—É—Ç —Å –¥–µ—Ç—å–º–∏ - —Å–ø—Ä–æ—Å–∏ –ø—Ä–æ –≤–æ–∑—Ä–∞—Å—Ç –¥–µ—Ç–µ–π.
–ï—Å–ª–∏ –µ–¥—É—Ç –∑–∏–º–æ–π –≤ –≥–æ—Ä—ã - —Å–ø—Ä–æ—Å–∏ –ø—Ä–æ –æ–ø—ã—Ç –∫–∞—Ç–∞–Ω–∏—è –Ω–∞ –ª—ã–∂–∞—Ö.
–ë—É–¥—å –≤–Ω–∏–º–∞—Ç–µ–ª—å–Ω—ã–º –∏ –∑–∞–¥–∞–≤–∞–π –†–ï–õ–ï–í–ê–ù–¢–ù–´–ï –≤–æ–ø—Ä–æ—Å—ã!

–ü–†–ê–í–ò–õ–ê –†–ê–ë–û–¢–´:
- –ó–∞–¥–∞–≤–∞–π –¢–û–õ–¨–ö–û –û–î–ò–ù –≤–æ–ø—Ä–æ—Å –∑–∞ —Ä–∞–∑
- –ñ–¥–∏ –æ—Ç–≤–µ—Ç–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–µ—Ä–µ–¥ —Å–ª–µ–¥—É—é—â–∏–º –≤–æ–ø—Ä–æ—Å–æ–º
- –û–±—â–∞–π—Å—è –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ, –¥—Ä—É–∂–µ–ª—é–±–Ω–æ, –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–æ
- –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–≤–µ—Ç–∏–ª –Ω–µ–ø–æ–ª–Ω–æ - –ø–µ—Ä–µ—Å–ø—Ä–æ—Å–∏
- –í–µ–¥–∏ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π —Å—á—ë—Ç –∑–∞–¥–∞–Ω–Ω—ã—Ö –≤–æ–ø—Ä–æ—Å–æ–≤ (–º–∏–Ω–∏–º—É–º 5)
- –ê–¥–∞–ø—Ç–∏—Ä—É–π –≤–æ–ø—Ä–æ—Å—ã –ø–æ–¥ –æ—Ç–≤–µ—Ç—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

–£–°–õ–û–í–ò–ï –ó–ê–í–ï–†–®–ï–ù–ò–Ø:
–ö–æ–≥–¥–∞ —Ç—ã –∑–∞–¥–∞–ª –ú–ò–ù–ò–ú–£–ú 5 –≤–æ–ø—Ä–æ—Å–æ–≤ –ò —Å–æ–±—Ä–∞–ª –í–°–Æ –Ω–µ–æ–±—Ö–æ–¥–∏–º—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –¥–ª—è –∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –ø–ª–∞–Ω–∞:

1. –ù–∞–ø–∏—à–∏ —Ñ—Ä–∞–∑—É: "===–°–ë–û–† –ó–ê–í–ï–†–®–Å–ù==="
2. –°–æ—Å—Ç–∞–≤—å –¥–µ—Ç–∞–ª—å–Ω—ã–π –ø–ª–∞–Ω –ø—É—Ç–µ—à–µ—Å—Ç–≤–∏—è —Å–æ —Å–ª–µ–¥—É—é—â–∏–º–∏ —Ä–∞–∑–¥–µ–ª–∞–º–∏:
   - –ó–∞–≥–æ–ª–æ–≤–æ–∫: "–ü–õ–ê–ù –ü–£–¢–ï–®–ï–°–¢–í–ò–Ø: [–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ]"
   - –ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ (2-3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è)
   - –ú–∞—Ä—à—Ä—É—Ç –ø–æ –¥–Ω—è–º (—É—á–∏—Ç—ã–≤–∞—è –∏–Ω—Ç–µ—Ä–µ—Å—ã –∏ –±—é–¥–∂–µ—Ç)
   - –û—Ä–∏–µ–Ω—Ç–∏—Ä–æ–≤–æ—á–Ω—ã–π –±—é–¥–∂–µ—Ç —Å —Ä–∞–∑–±–∏–≤–∫–æ–π
   - –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –∂–∏–ª—å—é
   - Must-see –º–µ—Å—Ç–∞ (—Ç–æ–ø-5)
   - –ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ —Å–æ–≤–µ—Ç—ã (—Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ –¥–ª—è —ç—Ç–æ–≥–æ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è)
   - –°–ø–∏—Å–æ–∫ –≤–µ—â–µ–π –¥–ª—è —É–ø–∞–∫–æ–≤–∫–∏
3. –ó–∞–∫–æ–Ω—á–∏ —Ñ—Ä–∞–∑–æ–π: "===–ü–õ–ê–ù –ì–û–¢–û–í==="

–í–ê–ñ–ù–û:
- –î–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Å–±–æ—Ä–∞ –¥–∞–Ω–Ω—ã—Ö –ù–ï –∏—Å–ø–æ–ª—å–∑—É–π –º–∞—Ä–∫–µ—Ä—ã ===–°–ë–û–† –ó–ê–í–ï–†–®–Å–ù=== –∏ ===–ü–õ–ê–ù –ì–û–¢–û–í===
- –û–±—â–∞–π—Å—è –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ, –∫–∞–∫ –∂–∏–≤–æ–π —á–µ–ª–æ–≤–µ–∫
- –ù–µ —É–ø–æ–º–∏–Ω–∞–π –Ω–æ–º–µ—Ä–∞ –≤–æ–ø—Ä–æ—Å–æ–≤ –≤ –¥–∏–∞–ª–æ–≥–µ
- –ù–µ –≥–æ–≤–æ—Ä–∏ "—ç—Ç–æ –±—ã–ª –≤–æ–ø—Ä–æ—Å 3 –∏–∑ 5" - –ø—Ä–æ—Å—Ç–æ –∑–∞–¥–∞–≤–∞–π –≤–æ–ø—Ä–æ—Å—ã
- –ë—É–¥—å –≥–∏–±–∫–∏–º –∏ –∞–¥–∞–ø—Ç–∏—Ä—É–π—Å—è –ø–æ–¥ –∫–ª–∏–µ–Ω—Ç–∞!
"""

conversation_history = []

def process_message(user_message):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è —Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º –∏—Å—Ç–æ—Ä–∏–∏"""
    
    conversation_history.append({
        "role": "user",
        "content": user_message
    })
    
    response = client.messages.create(
        model="claude-sonnet-4-20250514",
        max_tokens=2048,
        system=SYSTEM_PROMPT,
        messages=conversation_history
    )
    
    assistant_message = response.content[0].text
    
    conversation_history.append({
        "role": "assistant",
        "content": assistant_message
    })
    
    return assistant_message

def check_completion(response_text):
    """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç, –∑–∞–≤–µ—Ä—à—ë–Ω –ª–∏ —Å–±–æ—Ä –¥–∞–Ω–Ω—ã—Ö"""
    return "===–°–ë–û–† –ó–ê–í–ï–†–®–Å–ù===" in response_text and "===–ü–õ–ê–ù –ì–û–¢–û–í===" in response_text

def extract_plan(response_text):
    """–ò–∑–≤–ª–µ–∫–∞–µ—Ç –ø–ª–∞–Ω –∏–∑ –æ—Ç–≤–µ—Ç–∞ –∞–≥–µ–Ω—Ç–∞"""
    if "===–°–ë–û–† –ó–ê–í–ï–†–®–Å–ù===" in response_text:
        parts = response_text.split("===–°–ë–û–† –ó–ê–í–ï–†–®–Å–ù===")
        if len(parts) > 1:
            plan = parts[1].split("===–ü–õ–ê–ù –ì–û–¢–û–í===")[0]
            return plan.strip()
    return response_text

print("=" * 70)
print("AI –¢—Ä–µ–≤–µ–ª-–ê–≥–µ–Ω—Ç")
print("=" * 70)
print("\n–Ø –ø–æ–º–æ–≥—É —Å–ø–ª–∞–Ω–∏—Ä–æ–≤–∞—Ç—å –≤–∞—à–µ –∏–¥–µ–∞–ª—å–Ω–æ–µ –ø—É—Ç–µ—à–µ—Å—Ç–≤–∏–µ!")
print("–ö–æ–≥–¥–∞ –≤—Å–µ –¥–∞–Ω–Ω—ã–µ —Å–æ–±—Ä–∞–Ω—ã - —è —Å–æ—Å—Ç–∞–≤–ª—é –¥–µ—Ç–∞–ª—å–Ω—ã–π –ø–ª–∞–Ω")
print("\n–î–ª—è –≤—ã—Ö–æ–¥–∞: 'exit'\n")
print("-" * 70)

print("\n–ê–≥–µ–Ω—Ç: –ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ! –ì–æ—Ç–æ–≤—ã –Ω–∞—á–∞—Ç—å?\n")

while True:
    user_input = input("–í—ã: ").strip()
    
    if not user_input:
        continue
    
    if user_input.lower() in ['exit', '–≤—ã—Ö–æ–¥']:
        print("\nüëã –•–æ—Ä–æ—à–µ–≥–æ –ø—É—Ç–µ—à–µ—Å—Ç–≤–∏—è!")
        break
    
    try:
        response_text = process_message(user_input)
        
        is_completed = check_completion(response_text)
        
        if is_completed:
            print("\n" + "="*70)
            print("–î–ò–ê–õ–û–ì –ó–ê–í–ï–†–®–Å–ù! –ê–≥–µ–Ω—Ç —Å–æ–±—Ä–∞–ª –≤—Å—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é")
            print("="*70)
            
            plan = extract_plan(response_text)
            
            print(plan)

            print("\n" + "="*70)
            print("–ü–ª–∞–Ω –≥–æ—Ç–æ–≤! –•–æ—Ä–æ—à–µ–≥–æ –ø—É—Ç–µ—à–µ—Å—Ç–≤–∏—è!")
            print("\n–•–æ—Ç–∏—Ç–µ —Å–ø–ª–∞–Ω–∏—Ä–æ–≤–∞—Ç—å –µ—â—ë –æ–¥–Ω–æ –ø—É—Ç–µ—à–µ—Å—Ç–≤–∏–µ? (yes/no)")
            
            restart = input(">>> ").strip().lower()
            
            if restart == 'yes':
                conversation_history.clear()
                print("\n–û—Ç–ª–∏—á–Ω–æ! –ù–∞—á–∏–Ω–∞–µ–º –∑–∞–Ω–æ–≤–æ!\n")
                print("–ê–≥–µ–Ω—Ç: –ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ! –Ø –ø–æ–º–æ–≥—É —Å–ø–ª–∞–Ω–∏—Ä–æ–≤–∞—Ç—å –≤–∞—à–µ –ø—É—Ç–µ—à–µ—Å—Ç–≤–∏–µ. –ì–æ—Ç–æ–≤—ã –Ω–∞—á–∞—Ç—å?\n")
            else:
                print("\n–î–æ –≤—Å—Ç—Ä–µ—á–∏!")
                break
        else:
            print(f"\n–ê–≥–µ–Ω—Ç: {response_text}")
            print("-" * 70)
        
    except Exception as e:
        print(f"\n–û—à–∏–±–∫–∞: {str(e)}\n")